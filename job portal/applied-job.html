<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Applied Jobs</title>
  <link rel="icon" type="image/png" href="Images/icon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, sans-serif;
      background: url("Images/appliedjob.jpg") center/cover no-repeat fixed #f5f2ed;
      padding: 2rem;
    }

    .background-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(3, 3, 3, 0.688);
      z-index: 0;
    }
    .content {
      position: relative;
      z-index: 1;
    }

    button {
      background: linear-gradient(to right, #4B3621, #A9746E);
      color: #fff;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 5px;
      font-weight: bold;
      width: 100%;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      box-shadow: 0 4px 12px rgba(75,54,33,0.4);
      transform: scale(1.02);
    }

    .btn-coffee {
      background: linear-gradient(to right, #4B3621, #A9746E);
      color: #fff; border: none; font-weight: 500;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-coffee:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(75, 54, 33, 0.4);
    }

    .btn-coffee i { 
      vertical-align: middle; 
    }

    .fixed-btn {
      position: fixed;
      bottom: 130px;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .back-btn {
      left: 20px;
      background-color: #8d6e63;
    }

    #btn2 {
      right: 40px;
      border-radius: 30px;
      background: linear-gradient(to right, #5a3f36, #b46e63);
      transition: background 0.3s ease;
    }

    #btn2:hover {
      background: linear-gradient(to right, #4a332c, #a85d54);
    }
    
    #appliedJobsContainer .job-card {
      color: white;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2); 
    }

    /* Status Styles */
    .status-pending { 
      background-color: rgba(13, 110, 253, 0.9); /* Deep Blue */
      color: #fff; 
    }
    .status-accepted { background-color: #28a745; }
    .status-rejected { background-color: #dc3545; }
    .status-canceled { background-color: #6c757d; }
  </style>
</head>
<body>
<div class="background-overlay"></div>
<div class="content">
  <div class="container mt-5">
    <h2 class="mb-4 text-white">Jobs You Have Applied For</h2>
    <div id="appliedJobsContainer" class="row"></div>
    
    <a href="index.html" class="btn btn-coffee fixed-btn back-btn">
      <i class="bi bi-arrow-left-circle me-2"></i>Back To Home
    </a>
    
    <a href="search-job.html" id="btn2" class="btn btn-coffee fixed-btn" style="left: auto;">
      <i class="bi bi-arrow-left-circle me-2"></i>Search Jobs
    </a>
  </div>
  </div>
  <script>
    function checkAuth() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      // Ensure only job seekers can access this page
      if (!currentUser || currentUser.role !== 'jobseeker') {
        alert('You must be logged in as a Job Seeker to view this page.');
        window.location.href = 'index.html';
      }
      return currentUser;
    }

    function displayAppliedJobs() {
      const currentUser = checkAuth();
      const container = document.getElementById("appliedJobsContainer");
      const allApplicants = JSON.parse(localStorage.getItem("applicants")) || [];

      // Filter applications for the current logged-in user AND exclude canceled applications
      const userApplications = allApplicants.filter(app => 
        app.userId === currentUser.id && app.status !== 'canceled' // <-- FILTER CANCELED JOBS
      );

      container.innerHTML = "";

      if (userApplications.length === 0) {
        container.innerHTML = "<p class='text-white'>You haven't applied to any active jobs yet.</p>";
        return;
      }

      userApplications.forEach(app => {
        const statusClass = `status-${app.status || 'pending'}`;
        // Allow cancellation only if status is pending
        const canCancel = (app.status === 'pending' || !app.status); 

        const card = document.createElement("div");
        card.classList.add("col-md-4", "mb-4");
        card.innerHTML = `
          <div class="card h-100 text-white ${statusClass}">
            <div class="card-body">
              <h5 class="card-title">${app.jobTitle}</h5>
              <p class="card-text">${app.company} - ${app.location}</p>
              <p><strong>Status: ${app.status ? app.status.charAt(0).toUpperCase() + app.status.slice(1) : 'Pending'}</strong></p>
              <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-sm btn-light text-dark me-2" onclick="viewinfo(${app.appliedAt})">View Application</button>
                ${canCancel ? `<button class="btn btn-sm btn-dark" onclick="cancelApplication(${app.appliedAt})">Cancel Application</button>` : ''}
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

// In applied-job.html script:

function viewinfo(appliedAt) {
  localStorage.setItem("viewApplicationId", appliedAt);
  // ADDED: Set flag indicating viewer is a Job Seeker
  localStorage.setItem("viewerRole", "jobseeker"); 
  window.location.href = "info.html";
}

    function cancelApplication(appliedAt) {
      if (!confirm("Are you sure you want to cancel this application?")) return;

      let applicants = JSON.parse(localStorage.getItem("applicants")) || [];
      const index = applicants.findIndex(app => app.appliedAt === appliedAt);

      if (index !== -1) {
        // Mark as canceled instead of removing
        applicants[index].status = 'canceled';
        localStorage.setItem("applicants", JSON.stringify(applicants));
        alert("Application successfully canceled.");
        displayAppliedJobs(); // re-render the list
      }
    }


window.onload = displayAppliedJobs;
  </script>
</body>
</html>